# Publishing Guide

This package uses **Changesets** for versioning and publishing.

## Overview

- **Changesets**: Manages versioning and changelogs
- **tsdown**: Builds dual CJS/ESM bundles (powered by Rolldown)
- **GitHub Actions**: Automates publishing to npm

## Development Workflow

### 1. Making Changes

When you make changes that should be released:

```bash
# After making your changes, create a changeset
pnpm changeset
```

This will:

1. Ask you what type of change (major, minor, patch)
2. Ask you to describe the changes
3. Create a `.changeset/*.md` file

### 2. Changeset Types

- **Major (breaking)**: `1.0.0` â†’ `2.0.0`
    - Breaking API changes
    - Removed features

- **Minor (feature)**: `1.0.0` â†’ `1.1.0`
    - New features (backwards compatible)
    - New PostgreSQL type support

- **Patch (fix)**: `1.0.0` â†’ `1.0.1`
    - Bug fixes
    - Documentation updates

### 3. Committing

```bash
git add .
git commit -m "feat: add support for custom domains"
git push
```

## Publishing Process

### Automatic (Recommended)

When you push to `main`/`master`:

1. **GitHub Actions** runs CI tests
2. **Changesets Action** creates a "Version Packages" PR
3. Review and merge the PR
4. **Automatic publish** to npm

### Manual

If you need to publish manually:

```bash
# 1. Update versions from changesets
pnpm changeset version

# 2. Build the package
pnpm build

# 3. Publish to npm
pnpm changeset publish

# 4. Push tags
git push --follow-tags
```

## First-Time Setup

### npm Token

1. Login to npm:
   ```bash
   npm login
   ```

2. Create an automation token at https://www.npmjs.com/settings/YOUR_USERNAME/tokens

3. Add to GitHub repository secrets:
    - Go to: Settings â†’ Secrets and variables â†’ Actions
    - Add secret: `NPM_TOKEN` with your token value

### GitHub Permissions

The release workflow needs:

- `contents: write` - to create releases
- `pull-requests: write` - to create version PRs
- `id-token: write` - for npm provenance

These are configured in `.github/workflows/release.yml`.

## Package Configuration

### Dual Module Support

The package is built with dual CJS/ESM support:

```json
{
  "main": "./dist/index.cjs",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.mts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.cjs"
    }
  }
}
```

### Files Included

Only these files are published to npm:

- `dist/` - Compiled code
- `README.md` - Documentation
- `LICENSE` - License file
- `CHANGELOG.md` - Changelog (auto-generated)

## Version History

Versions are tracked in:

- `package.json` - Current version
- `CHANGELOG.md` - Full changelog (auto-generated by changesets)
- Git tags - Each version is tagged

## Troubleshooting

### "No changesets found"

You need to create a changeset before publishing:

```bash
pnpm changeset
```

### "NPM_TOKEN not found"

Add your npm token to GitHub secrets (see "First-Time Setup" above).

### Build fails

Make sure TypeScript compiles:

```bash
pnpm build
pnpm tsc --noEmit
```

### Exports not working

Test both module systems:

```bash
# Test CJS
node -e "require('./dist/index.cjs')"

# Test ESM
node --input-type=module -e "import('./dist/index.mjs')"
```

## Best Practices

1. **Always create changesets** for user-facing changes
2. **Group related changes** in a single changeset
3. **Write clear descriptions** - they become your changelog
4. **Test before publishing** - CI must pass
5. **Use semantic versioning** - follow semver.org guidelines

## Example Workflow

```bash
# 1. Make your changes
# ... edit files ...

# 2. Test locally
pnpm build
pnpm test

# 3. Create changeset
pnpm changeset
# Select: minor
# Describe: "Add support for PostgreSQL enums in arrays"

# 4. Commit and push
git add .
git commit -m "feat: support enums in arrays"
git push

# 5. GitHub Actions creates version PR
# 6. Review and merge PR
# 7. Package is auto-published! ðŸŽ‰
```

## Resources

- [Changesets Documentation](https://github.com/changesets/changesets)
- [Semantic Versioning](https://semver.org/)
- [npm Publishing Guide](https://docs.npmjs.com/packages-and-modules/contributing-packages-to-the-registry)
- [tsdown Documentation](https://tsdown.vercel.app/)
