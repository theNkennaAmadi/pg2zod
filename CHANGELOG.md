# Changelog

## 2.2.4

### Patch Changes

- Fixed type mapping for `numeric(precision,scale)` types (e.g., `numeric(10,2)`) - now correctly extracts base type `numeric` for proper Zod schema generation. Fixed type mapping for array types with `text[]` format - now correctly recognizes and maps array columns to `z.array(z.string())`. Improved array detection in introspection to handle both `ARRAY` data type and `udt_name` formats (`text[]` or `_text`). Fixed domain type detection - now checks `udt_name` as fallback when `domain_name` column is not set in information_schema, fixing unrecognized domain types like `http_method`.

## 2.2.3

### Patch Changes

- **Bug Fixes:**
  - Fixed type mapping for `numeric(precision,scale)` types (e.g., `numeric(10,2)`) - now correctly extracts base type `numeric` for proper Zod schema generation
  - Fixed type mapping for array types with `text[]` format - now correctly recognizes and maps array columns to `z.array(z.string())`
  - Improved array detection in introspection to handle both `ARRAY` data type and `udt_name` formats (`text[]` or `_text`)
  - Fixed domain type detection - now checks `udt_name` as fallback when `domain_name` column is not set in information_schema, fixing unrecognized domain types like `http_method`

## 2.2.2

### Patch Changes

- **New Features:**

  - Added foreign key relationship introspection and metadata to Database type interface
  - Each table in the Database type now includes a `Relationships` array with foreign key information (foreignKeyName, columns, isOneToOne, referencedRelation, referencedColumns)
  - Database type sections (Tables, Views, Functions, Enums, CompositeTypes) are now always present even when empty, using `[_ in never]: never` for empty sections
  - Relationships array is always present for each table, showing `[]` if no foreign keys exist

  **Improvements:**

  - Database type structure now consistently matches Supabase's type generator format
  - Better type safety with always-present sections in Database interface
  - Fixed array parsing for relationship columns from PostgreSQL queries

## 2.2.1

### Patch Changes

- **Bug Fixes:**

  - Fixed connection URL parser to properly handle query parameters (e.g., `?sslmode=verify-full&sslrootcert=system`)
  - Database name is now correctly extracted before query string instead of including the entire query string
  - SSL mode is now properly parsed from query parameters and configured appropriately
  - Improved array and custom type detection in type mapper to handle both `_text` and `text[]` udtName formats
  - Fixed enum, composite type, and range type lookups to check both base and original udtName for arrays
  - Removed unused variable warning in Database type generation

## 2.2.0

### Minor Changes

- **New Features:**

  - **Database Type Generation**: Added a top-level `Database` interface that organizes all generated types by schema, similar to Supabase's type generator. This provides a structured way to access all table, view, function, enum, and composite type definitions.

  - **Views now generated by default**: Database views are now included in the output by default. Use `--no-views` to skip them.

  - **Routines (functions/procedures) now generated by default**: Database functions and procedures are now included by default. Use `--no-routines` to skip them.

  - **Composite types now generated by default**: Composite types are now included by default. Use `--no-composite-types` to skip them.

  **Breaking Changes:**

  - **View schema naming**: View schemas now include a `View` suffix to prevent naming conflicts with tables (e.g., `PublicPersonSummaryViewSchema` instead of `PublicPersonSummarySchema`).

  - **Default behavior change**: Views, routines, and composite types are now generated by default. Users who want the old behavior should use `--no-views`, `--no-routines`, and `--no-composite-types` flags.

  **Improvements:**

  - Functions without parameters now correctly generate `Args: Record<string, never>` in the Database type
  - Functions without return values now correctly generate `Returns: void` in the Database type
  - Better handling of edge cases in function parameter and return type generation

## 2.1.2

### Patch Changes

- 9cd667c: Filter internal PostgreSQL functions and handle duplicates

  **Bug Fixes:**

  - Fixed type errors in view column metadata generation
  - Removed invalid fields (ordinalPosition, isIdentity, etc.) from ColumnMetadata

  **Improvements:**

  - Filter out internal PostgreSQL system functions (functions using internal, trigger, cstring, "char", and other low-level types)
  - Skip functions with duplicate parameter names that would cause invalid TypeScript
  - Skip overloaded functions - only keep first occurrence to avoid naming conflicts
  - Significantly reduces generated function count (from 261 to ~50-60 for typical databases)
  - Generated schemas now compile without TypeScript errors

  **Quality:**

  - Ensures only user-facing, application-relevant functions are included in generated schemas
  - Cleaner output with fewer warnings about unmapped internal types

## 2.1.0

### Minor Changes

- 9bb84ad: Add support for generating Zod schemas from database views and functions/procedures

  **New Features:**

  - Database views: Generate read-only Zod schemas from views (--views flag)
  - Functions/Procedures: Generate parameter and return type schemas (--routines flag)
  - Security-aware filtering: By default only SECURITY DEFINER functions are included
  - Include SECURITY INVOKER functions with --security-invoker flag

  **New CLI Options:**

  - `--views`: Include database views in schema generation
  - `--routines`: Include functions and procedures
  - `--security-invoker`: Include SECURITY INVOKER routines (default: DEFINER only)

  **API Changes:**

  - Added `includeViews` option to SchemaGenerationOptions
  - Added `includeRoutines` option to SchemaGenerationOptions
  - Added `includeSecurityInvoker` option to SchemaGenerationOptions
  - Added `ViewMetadata`, `RoutineMetadata`, and `RoutineParameterMetadata` types
  - GenerationResult now includes `views` and `routines` arrays

## 2.0.0

### Major Changes

- 64f3673: Initial release of pg-to-zod - a comprehensive PostgreSQL to Zod v4 schema generator.

  **Features:**

  - Complete PostgreSQL database introspection
  - Comprehensive type coverage (50+ PostgreSQL types)
  - Strict Zod v4 schema generation
  - CHECK constraint parsing and automatic enum generation
  - CLI interface with comprehensive options
  - Programmatic API for integration
  - Support for enums, domains, composite types, and range types
  - Multi-dimensional array support
  - Smart Insert/Update schema generation (default behavior)
  - Schema-prefixed naming to avoid collisions
  - Dual CJS/ESM module support
  - Composite types optional (use `--composite-types` flag)

  **Type Mappings:**

  - All PostgreSQL built-in types with proper Zod v4 validators
  - Custom types: enums, domains, composite types, range types
  - Network types with proper validation (inet, cidr, macaddr)
  - Geometric types support
  - Arrays including multi-dimensional

  **Schema Generation:**

  - Three schemas per table: Read, Insert, Update
  - Read schema reflects actual database structure
  - Insert schema with intelligent optional field detection
  - Update schema with `.partial()` for flexible updates
  - Schema-prefixed naming (e.g., `PublicUsersSchema`)

All notable changes to this project will be documented in this file.

## [1.0.0] - 2026-01-10

### Initial Release

**Features:**

- Complete PostgreSQL database introspection
- Comprehensive type coverage (50+ PostgreSQL types)
- Strict Zod v4 schema generation
- CHECK constraint parsing and automatic enum generation
- CLI interface with comprehensive options
- Programmatic API for integration
- Support for enums, domains, composite types, and range types
- Multi-dimensional array support
- Smart Insert/Update schema generation (default behavior)
- Schema-prefixed naming to avoid collisions (e.g., `PublicUsersSchema`)
- camelCase field name conversion
- Environment variable support
- Composite types optional (use `--composite-types` flag)

**Type Mappings (Zod v4):**

- Basic types: smallint, integer, bigint, numeric, real, double precision
- Text types: varchar, char, text, citext with length constraints
- Boolean
- Date/time: date, timestamp, time (using `z.iso.time()`), interval (using `z.iso.duration()`)
- UUID: `z.uuid()`
- JSON/JSONB
- Network types: inet (`z.union([z.ipv4(), z.ipv6()])`), cidr (`z.union([z.cidrv4(), z.cidrv6()])`), macaddr (`z.mac()`)
- Geometric types: point, box, circle, polygon, etc.
- Arrays including multi-dimensional
- Bit strings
- Full-text search: tsvector, tsquery
- Binary data: bytea
- Custom types: enums, domains, composite types, range types

**Constraint Support:**

- NOT NULL awareness
- Length constraints (varchar, char)
- Numeric precision/scale
- CHECK constraint parsing and implementation:
  - Numeric comparisons: `>, <, >=, <=`
  - BETWEEN: `value BETWEEN min AND max`
  - IN/ANY(ARRAY): `value = ANY (ARRAY[...])` → `z.enum([...])`
  - Regex: `value ~ 'pattern'` → `z.string().regex(/pattern/)`
  - Length: `length(value) >= n` → `z.string().min(n)`
- Default value handling
- Auto-generated fields (SERIAL, IDENTITY)

**Documentation:**

- Comprehensive README
- Getting Started guide
- Project summary
- Example schema SQL
- Example usage code
- CLI help documentation

### Changed (Zod v4 Updates)

Updated type mappings to use correct Zod v4 APIs following the Zod 4 migration:

**String Format Validators → Top-Level Helpers:**

- `z.string().uuid()` → `z.uuid()` (stricter RFC 9562/4122 compliant)
- `z.string().ip()` → `z.union([z.ipv4(), z.ipv6()])` (separate validators for IPv4/IPv6)
- `z.string().email()` → `z.email()` (top-level helper)
- `z.string().url()` → `z.url()` (top-level helper)

**ISO Date/Time Validators:**

- Time types now use `z.iso.time()` instead of regex
- Interval types now use `z.iso.duration()` for ISO 8601 duration strings
- Date types continue to use `z.date()` for JavaScript Date objects

**Network Types:**

- `inet` → `z.union([z.ipv4(), z.ipv6()])` (supports both IPv4 and IPv6)
- `cidr` → `z.union([z.cidrv4(), z.cidrv6()])` (supports both CIDR notations)
- `macaddr` → `z.mac()` (supports configurable delimiters)
- `macaddr8` → continues to use regex (64-bit MAC addresses)

**Benefits:**

- More accurate type validation using native Zod v4 validators
- Better error messages from specialized validators
- Stricter UUID validation (RFC compliant)
- Proper ISO 8601 time and duration parsing
- Improved IP address validation with separate IPv4/IPv6 types
